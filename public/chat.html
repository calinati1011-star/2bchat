<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<link rel="stylesheet" href="style.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="chat-container">
  <div class="users" id="users"></div>
  <div class="messages" id="messages"></div>
  <input type="text" id="msgInput" placeholder="Scrivi un messaggio">
  <input type="file" id="imgInput">
  <button onclick="sendMsg()">Invia</button>
</div>

<script>
const socket = io()
const params = new URLSearchParams(window.location.search)
const room = params.get("room")
const username = localStorage.getItem("username")
if(!username) location.href = "index.html"

socket.emit("join",{user:username,room})

const messages = document.getElementById("messages")
const users = document.getElementById("users")

socket.on("history",data => {
  data.forEach(m => addMsg(m))
})

socket.on("msg", addMsg)
socket.on("system", m => addSysMsg(m))
socket.on("users", list => users.innerHTML = list.map(u=>u).join("<br>"))

function addMsg(m){
  const el = document.createElement("div")
  if(m.type === "text") el.textContent = `[${m.time}] ${m.user}: ${m.content}`
  if(m.type === "image"){
    const img = document.createElement("img")
    img.src = m.content
    img.style.maxWidth = "200px"
    el.appendChild(document.createTextNode(`[${m.time}] ${m.user}: `))
    el.appendChild(img)
  }
  messages.appendChild(el)
  messages.scrollTop = messages.scrollHeight
}

function addSysMsg(m){
  const el = document.createElement("div")
  el.style.color="red"
  el.textContent = m
  messages.appendChild(el)
  messages.scrollTop = messages.scrollHeight
}

function sendMsg(){
  const input = document.getElementById("msgInput")
  const file = document.getElementById("imgInput").files[0]
  if(file){
    const form = new FormData()
    form.append("image",file)
    fetch("/upload",{method:"POST",body:form})
      .then(res=>res.json())
      .then(data=>{
        socket.emit("msg",{room,user:username,type:"image",content:data.path})
      })
  } else if(input.value){
    socket.emit("msg",{room,user:username,type:"text",content:input.value})
  }
  input.value=""
}
</script>
</body>
</html>
